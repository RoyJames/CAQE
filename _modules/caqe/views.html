

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>caqe.views &mdash; CAQE 0.1.1a1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="CAQE 0.1.1a1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> CAQE
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recruiting_on_amt.html">Running the Evaluation on Amazon&#8217;s Mechanical Turk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_analysis.html">Downloading and Analyzing Data</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../test_configurations.html">Test Configurations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/caqe.html">CAQE Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/scripts.html">Scripts</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">CAQE</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>caqe.views</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for caqe.views</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">URL route handlers</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> \
    <span class="n">safe_join</span><span class="p">,</span> <span class="n">url_for</span>

<span class="kn">import</span> <span class="nn">experiment</span>

<span class="kn">from</span> <span class="nn">caqe</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">caqe</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Participant</span><span class="p">,</span> <span class="n">Trial</span><span class="p">,</span> <span class="n">Condition</span>
<span class="kn">import</span> <span class="nn">caqe.utilities</span> <span class="kn">as</span> <span class="nn">utilities</span>
<span class="kn">import</span> <span class="nn">caqe.configuration</span> <span class="kn">as</span> <span class="nn">configuration</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="nocache"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.nocache">[docs]</a><span class="k">def</span> <span class="nf">nocache</span><span class="p">(</span><span class="n">view</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    No cache decorator. Puts no cache directives in header to avoid caching of endpoint.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    view : flask view function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">no_cache</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Last-Modified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no-store, no-cache, must-revalidate, post-check=0, pre-check=0, max-age=0&#39;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Pragma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no-cache&#39;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-1&#39;</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">no_cache</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span></div>


<div class="viewcode-block" id="strip_query_from_url"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.strip_query_from_url">[docs]</a><span class="k">def</span> <span class="nf">strip_query_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the a URL without the query, which may be simply used for cache busting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    stripped_url : str</span>
<span class="sd">        URL stripped of query strings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># strip query portion (since its a hash for cache busting of static urls)</span>
    <span class="n">split_url</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="n">split_url</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">stripped_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunsplit</span><span class="p">(</span><span class="n">split_url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stripped_url</span></div>


<div class="viewcode-block" id="get_current_participant"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.get_current_participant">[docs]</a><span class="k">def</span> <span class="nf">get_current_participant</span><span class="p">(</span><span class="n">current_session</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the participant based on the `participant_id` in the current session.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    current_session : flask.Session</span>
<span class="sd">    allow_none : bool, optional</span>
<span class="sd">        If `allow_none`==False, then if `participant_id` is not defined or the id is invalid, then raise an exception,</span>
<span class="sd">        otherwise return None. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    participant : caqe.models.Participant</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">participant_id</span> <span class="o">=</span> <span class="n">current_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;participant_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">participant_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_none</span><span class="p">:</span>
            <span class="c1"># if this happens, either there is a bug in the software, or we are having trouble writing and retrieving</span>
            <span class="c1"># to the session. Since Amazon loads the page in an iframe, this can happen if the user has third-party</span>
            <span class="c1"># cookies disabled in their browser. By default Safari does this, but Chrome and Firefox do not.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;session[</span><span class="se">\&#39;</span><span class="s1">participant_id</span><span class="se">\&#39;</span><span class="s1">]=None is invalid. This could mean that third party cookies are &#39;</span>
                         <span class="s1">&#39;not enabled.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;An error has occurred. Please make sure that third-party &#39;</span>
                                                         <span class="s1">&#39;cookies are enabled in your browser and then reload this &#39;</span>
                                                         <span class="s1">&#39;page. (Note that by default these are disabled in Safari, but&#39;</span>
                                                         <span class="s1">&#39; are enabled in Chrome and Firefox&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="n">participant</span> <span class="o">=</span> <span class="n">Participant</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">participant_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">participant</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_none</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;session[</span><span class="se">\&#39;</span><span class="s1">participant_id</span><span class="se">\&#39;</span><span class="s1">]=</span><span class="si">%d</span><span class="s1"> is invalid.&#39;</span> <span class="o">%</span> <span class="n">participant_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">participant</span></div>


<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<div class="viewcode-block" id="internal_server_error"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.internal_server_error">[docs]</a><span class="k">def</span> <span class="nf">internal_server_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    500 Internal Server Error page</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    e : Exception</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;500 Internal Server Error -- Whoops... an error occurred. Sorry &#39;</span>
                                                 <span class="s1">&#39;about that. Contact us if this keeps happening. Thanks!&#39;</span><span class="p">),</span> <span class="mi">500</span></div>


<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<div class="viewcode-block" id="page_not_found"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.page_not_found">[docs]</a><span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    404 Page Not Found page</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    e : Exception</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;404 Page Not Found -- Sorry, that page doesn</span><span class="se">\&#39;</span><span class="s1">t exist.&#39;</span><span class="p">),</span> <span class="mi">404</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/audio/&lt;audio_file_key&gt;.wav&#39;</span><span class="p">)</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="audio"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.audio">[docs]</a><span class="k">def</span> <span class="nf">audio</span><span class="p">(</span><span class="n">audio_file_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return audio from audio file URL in `audio_file_key`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    audio_file_key: str</span>
<span class="sd">        The encrypted key that contains a dictionary that included an item keyed by &#39;path&#39; which is the location of the</span>
<span class="sd">        audio file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ENCRYPT_AUDIO_STIMULI_URLS&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">audio_file_dict</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">decrypt_data</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">audio_file_key</span><span class="p">))</span>

            <span class="c1"># can also assert that this file is for this specific participant and condition</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">audio_file_dict</span><span class="p">[</span><span class="s1">&#39;p_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;participant_id&#39;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">audio_file_dict</span><span class="p">[</span><span class="s1">&#39;g_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;condition_group_ids&#39;</span><span class="p">])</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">audio_file_dict</span><span class="p">[</span><span class="s1">&#39;URL&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">audio_file_key</span> <span class="o">+</span> <span class="s1">&#39;.wav&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">audio_file_key</span> <span class="o">+</span> <span class="s1">&#39;.wav&#39;</span>

    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">safe_join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUDIO_FILE_DIRECTORY&#39;</span><span class="p">]),</span> <span class="n">filename</span><span class="p">)</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/anonymous&#39;</span><span class="p">)</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="anonymous"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.anonymous">[docs]</a><span class="k">def</span> <span class="nf">anonymous</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the entry point for an anonymous participant (i.e. no external id is available)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">preview</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preview&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ANONYMOUS_PARTICIPANTS_ENABLED&#39;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Anonymous participant attempted access, but anonymous participants is disabled.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;This experiment is currently closed to anonymous participants.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;begin&#39;</span><span class="p">,</span>
                            <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;anonymous&#39;</span><span class="p">,</span>
                            <span class="n">preview</span><span class="o">=</span><span class="n">preview</span><span class="p">,</span>
                            <span class="n">submission_url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="n">crowd_worker_id</span><span class="o">=</span><span class="s2">&quot;ANONYMOUS&quot;</span><span class="p">,</span>
                            <span class="n">crowd_assignment_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">crowd_assignment_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/mturk&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="mturk"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.mturk">[docs]</a><span class="k">def</span> <span class="nf">mturk</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the entry point for an Amazon Turker.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;assignmentId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ASSIGNMENT_ID_NOT_AVAILABLE&#39;</span><span class="p">:</span>
        <span class="n">preview</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">submission_url</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">crowd_worker_id</span> <span class="o">=</span> <span class="s1">&#39;WORKER_ID_NOT_AVAILABLE&#39;</span>
        <span class="n">crowd_assignment_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">crowd_assignment_type</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">preview</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">submission_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;turkSubmitTo&#39;</span><span class="p">,</span> <span class="s1">&#39;TURK_SUBMIT_TO_NOT_AVAILABLE&#39;</span><span class="p">),</span>
                                          <span class="s1">&#39;mturk/externalSubmit&#39;</span><span class="p">)</span>
        <span class="n">crowd_worker_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workerId&#39;</span><span class="p">,</span> <span class="s1">&#39;WORKER_ID_NOT_AVAILABLE&#39;</span><span class="p">)</span>
        <span class="n">crowd_assignment_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assignmentId&#39;</span><span class="p">,</span> <span class="s1">&#39;ASSIGNMENT_ID_NOT_AVAILABLE&#39;</span><span class="p">)</span>
        <span class="n">crowd_assignment_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hitId&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;begin&#39;</span><span class="p">,</span>
                            <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;mturk&#39;</span><span class="p">,</span>
                            <span class="n">crowd_worker_id</span><span class="o">=</span><span class="n">crowd_worker_id</span><span class="p">,</span>
                            <span class="n">submission_url</span><span class="o">=</span><span class="n">submission_url</span><span class="p">,</span>
                            <span class="n">crowd_assignment_id</span><span class="o">=</span><span class="n">crowd_assignment_id</span><span class="p">,</span>
                            <span class="n">crowd_assignment_type</span><span class="o">=</span><span class="n">crowd_assignment_type</span><span class="p">,</span>
                            <span class="n">preview</span><span class="o">=</span><span class="n">preview</span><span class="p">,</span>
                            <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/begin/&lt;platform&gt;/&lt;crowd_worker_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="begin"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.begin">[docs]</a><span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">crowd_worker_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a page with a button on it that directs them to the assign conditions. We don&#39;t direct them initially to the</span>
<span class="sd">    evaluation page since some workers accept many HITs at a time. We need to make sure that they don&#39;t get assigned</span>
<span class="sd">    the same conditions and that their session data is valid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    platform : str</span>
<span class="sd">    crowd_worker_id : str</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement platform-specific rendering support</span>

    <span class="c1"># check browser</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">browser</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ACCEPTABLE_BROWSERS&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">browser</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ACCEPTABLE_BROWSERS&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;We</span><span class="se">\&#39;</span><span class="s1">re sorry, but your web browser is not supported. Please try &#39;</span>
                                                     <span class="s1">&#39;again using &lt;a href=&quot;http://www.google.com/chrome&quot; &#39;</span>
                                                     <span class="s1">&#39;target=&quot;_blank&quot;&gt;Chrome&lt;/a&gt;.&#39;</span><span class="p">)</span>

    <span class="c1"># check conditions if conditions available for anyone</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">get_available_conditions</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">conditions</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;We</span><span class="se">\&#39;</span><span class="s1">re sorry, but there are no more tasks available.&#39;</span><span class="p">)</span>

    <span class="c1"># render preview if True</span>
    <span class="n">preview</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preview&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">preview</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;preview.html&#39;</span><span class="p">,</span>
                               <span class="n">link</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                               <span class="n">preview_html</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREVIEW_HTML&#39;</span><span class="p">],</span>
                               <span class="o">**</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;BEGIN_BUTTON_ENABLED&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;mturk&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;mturk/begin.html&#39;</span><span class="p">,</span>
                                   <span class="n">link</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;create_participant&#39;</span><span class="p">,</span>
                                                <span class="n">participant_type</span><span class="o">=</span><span class="n">platform</span><span class="p">,</span>
                                                <span class="n">crowd_worker_id</span><span class="o">=</span><span class="n">crowd_worker_id</span><span class="p">,</span>
                                                <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">],</span>
                                                <span class="o">**</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
                                   <span class="n">width</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;POPUP_WIDTH&#39;</span><span class="p">],</span>
                                   <span class="n">height</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;POPUP_HEIGHT&#39;</span><span class="p">],</span>
                                   <span class="n">crowd_worker_id</span><span class="o">=</span><span class="n">crowd_worker_id</span><span class="p">,</span>
                                   <span class="n">crowd_assignment_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;crowd_assignment_id&#39;</span><span class="p">),</span>
                                   <span class="n">crowd_assignment_type</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;crowd_assignment_type&#39;</span><span class="p">),</span>
                                   <span class="n">submission_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;submission_url&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;begin.html&#39;</span><span class="p">,</span>
                                   <span class="n">link</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;create_participant&#39;</span><span class="p">,</span>
                                                <span class="n">participant_type</span><span class="o">=</span><span class="n">platform</span><span class="p">,</span>
                                                <span class="n">crowd_worker_id</span><span class="o">=</span><span class="n">crowd_worker_id</span><span class="p">,</span>
                                                <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">],</span>
                                                <span class="o">**</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
                                   <span class="n">width</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;POPUP_WIDTH&#39;</span><span class="p">],</span>
                                   <span class="n">height</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;POPUP_HEIGHT&#39;</span><span class="p">],</span>
                                   <span class="o">**</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;create_participant&#39;</span><span class="p">,</span>
                                <span class="n">participant_type</span><span class="o">=</span><span class="n">platform</span><span class="p">,</span>
                                <span class="n">crowd_worker_id</span><span class="o">=</span><span class="n">crowd_worker_id</span><span class="p">,</span>
                                <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">],</span>
                                <span class="o">**</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">))</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/participant/&lt;participant_type&gt;/&lt;crowd_worker_id&gt;&#39;</span><span class="p">)</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="create_participant"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.create_participant">[docs]</a><span class="k">def</span> <span class="nf">create_participant</span><span class="p">(</span><span class="n">participant_type</span><span class="p">,</span> <span class="n">crowd_worker_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get or create participant from crowd_worker_id. Save variables to session.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    participant_type : str</span>
<span class="sd">        The type of participant, e.g. ANONYMOUS, M_TURK, LAB, etc.</span>
<span class="sd">    crowd_worker_id : str</span>
<span class="sd">        An external identifier</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Check to see if this participant has accessed CAQE before and already exists in the database</span>
    <span class="n">participant</span> <span class="o">=</span> <span class="n">Participant</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">crowd_worker_id</span><span class="o">=</span><span class="n">crowd_worker_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="c1"># participant not found create new participant</span>
    <span class="k">if</span> <span class="n">participant</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">participant</span> <span class="o">=</span> <span class="n">Participant</span><span class="p">(</span><span class="n">participant_type</span><span class="p">,</span> <span class="n">crowd_worker_id</span><span class="o">=</span><span class="n">crowd_worker_id</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">participant</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New Participant - </span><span class="si">%r</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">participant</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Participant has returned - </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">participant</span><span class="p">)</span>

    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;participant_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">participant</span><span class="o">.</span><span class="n">id</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;crowd_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># TODO: NOTE that these are platform specific.... this needs to change.</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;crowd_data&#39;</span><span class="p">][</span><span class="s1">&#39;hit_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hitId&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;crowd_data&#39;</span><span class="p">][</span><span class="s1">&#39;assignment_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assignmentId&#39;</span><span class="p">,</span> <span class="s1">&#39;ASSIGNMENT_ID_NOT_AVAILABLE&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;crowd_data&#39;</span><span class="p">][</span><span class="s1">&#39;turk_submit_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;turkSubmitTo&#39;</span><span class="p">,</span> <span class="s1">&#39;TURK_SUBMIT_TO_NOT_AVAILABLE&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PRE_EVALUATION&#39;</span>

    <span class="k">return</span> <span class="n">pre_evaluation_tasks</span><span class="p">()</span></div>


<div class="viewcode-block" id="pre_evaluation_tasks"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.pre_evaluation_tasks">[docs]</a><span class="k">def</span> <span class="nf">pre_evaluation_tasks</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Control overall flow of pre-evaluation tasks.</span>
<span class="sd">    * Assign conditions</span>
<span class="sd">    * Obtain consent if required</span>
<span class="sd">    * Present hearing screening if required</span>
<span class="sd">    * Present pre-test survey if required</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">participant</span> <span class="o">=</span> <span class="n">get_current_participant</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="c1"># assign conditions</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;condition_ids&#39;</span><span class="p">],</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;condition_group_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">assign_conditions</span><span class="p">(</span><span class="n">participant</span><span class="p">)</span>

    <span class="c1"># Are there any conditions left for the participant to do?</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;condition_ids&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;condition_ids&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;We</span><span class="se">\&#39;</span><span class="s1">re sorry, but there are no more tasks available for you.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;OBTAIN_CONSENT&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">participant</span><span class="o">.</span><span class="n">gave_consent</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;consent&#39;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;HEARING_SCREENING_TEST_ENABLED&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">participant</span><span class="o">.</span><span class="n">has_passed_hearing_test_recently</span><span class="p">()):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;hearing_test&#39;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PRE_TEST_SURVEY_ENABLED&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">participant</span><span class="o">.</span><span class="n">pre_test_survey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;pre_test_survey&#39;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">experiment</span><span class="o">.</span><span class="n">is_pre_test_survey_valid</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">participant</span><span class="o">.</span><span class="n">pre_test_survey</span><span class="p">),</span>
                                                   <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PRE_TEST_SURVEY_INCLUSION_CRITERIA&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span>
                                   <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Unfortunately, you do not meet the inclusion criteria for this study. &#39;</span>
                                           <span class="s1">&#39;Sorry.&#39;</span><span class="p">)</span>

    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;EVALUATION&#39;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/consent&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="consent"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.consent">[docs]</a><span class="k">def</span> <span class="nf">consent</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display consent page (if GET) and store results (if POST)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;consent&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;agree&#39;</span><span class="p">:</span>
            <span class="n">participant</span> <span class="o">=</span> <span class="n">get_current_participant</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="n">participant</span><span class="o">.</span><span class="n">gave_consent</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">pre_evaluation_tasks</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;consent&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;disagree&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Thank you for your interest in the study.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;consent.html&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;consent.html&#39;</span><span class="p">)</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/pre_test_survey&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="pre_test_survey"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.pre_test_survey">[docs]</a><span class="k">def</span> <span class="nf">pre_test_survey</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display pre-test survey (if GET) and store results (if POST)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">participant</span> <span class="o">=</span> <span class="n">get_current_participant</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">participant</span><span class="o">.</span><span class="n">pre_test_survey</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">experiment</span><span class="o">.</span><span class="n">is_pre_test_survey_valid</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PRE_TEST_SURVEY_INCLUSION_CRITERIA&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">pre_evaluation_tasks</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span>
                                   <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Unfortunately, you do not meet the inclusion criteria for this study. &#39;</span>
                                           <span class="s1">&#39;Sorry.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;pre_test_survey.html&#39;</span><span class="p">)</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/hearing_test&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="hearing_test"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.hearing_test">[docs]</a><span class="k">def</span> <span class="nf">hearing_test</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines if the user is eligible to take the hearing test (i.e. has not exceeded `MAX_HEARING_TEST_ATTEMPTS`, and</span>
<span class="sd">    then renders the hearing test, which consists of the assessor counting the tones in two audio files.</span>

<span class="sd">    If caqe.settings.HEARING_TEST_REJECTION_ENABLED is set to False, then pass them through after they had their 2</span>
<span class="sd">    attempts.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">participant</span> <span class="o">=</span> <span class="n">get_current_participant</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">participant</span><span class="o">.</span><span class="n">hearing_test_attempts</span> <span class="o">&gt;=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MAX_HEARING_TEST_ATTEMPTS&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Max hearing test attempts reached - </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">participant</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;sorry.html&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Sorry. You have exceed the number of allowed attempts. &#39;</span>
                                                         <span class="s1">&#39;Please try again tomorrow.&#39;</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">hearing_test_audio_index1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">MIN_HEARING_TEST_AUDIO_INDEX</span><span class="p">,</span>
                                                       <span class="n">configuration</span><span class="o">.</span><span class="n">MAX_HEARING_TEST_AUDIO_INDEX</span><span class="p">)</span>
            <span class="n">hearing_test_audio_index2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">MIN_HEARING_TEST_AUDIO_INDEX</span><span class="p">,</span>
                                                       <span class="n">configuration</span><span class="o">.</span><span class="n">MAX_HEARING_TEST_AUDIO_INDEX</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hearing_test_audio_index1</span> <span class="o">!=</span> <span class="n">hearing_test_audio_index2</span><span class="p">:</span>
                <span class="c1"># encrypt the data so that someone can&#39;t figure out the pattern on the client side</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hearing test indices </span><span class="si">%d</span><span class="s1"> and </span><span class="si">%d</span><span class="s1"> assigned to </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">hearing_test_audio_index1</span><span class="p">,</span> <span class="n">hearing_test_audio_index2</span><span class="p">,</span> <span class="n">participant</span><span class="p">))</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;hearing_test_audio_index1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">encrypt_data</span><span class="p">(</span><span class="n">hearing_test_audio_index1</span><span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;hearing_test_audio_index2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">encrypt_data</span><span class="p">(</span><span class="n">hearing_test_audio_index2</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;hearing_screening.html&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hearing_test_audio_index1</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;hearing_test_audio_index1&#39;</span><span class="p">]</span>
            <span class="n">hearing_test_audio_index2</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;hearing_test_audio_index2&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">hearing_test_audio_index1</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">hearing_test_audio_index2</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid state - </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;audiofile1_tones&#39;</span><span class="p">])</span> <span class="o">==</span>
                <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">decrypt_data</span><span class="p">(</span><span class="n">hearing_test_audio_index1</span><span class="p">))</span> <span class="o">/</span>
                     <span class="n">configuration</span><span class="o">.</span><span class="n">HEARING_TEST_AUDIO_FILES_PER_TONES</span><span class="p">))</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;audiofile2_tones&#39;</span><span class="p">])</span> <span class="o">==</span>
                         <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">decrypt_data</span><span class="p">(</span><span class="n">hearing_test_audio_index2</span><span class="p">))</span> <span class="o">/</span>
                              <span class="n">configuration</span><span class="o">.</span><span class="n">HEARING_TEST_AUDIO_FILES_PER_TONES</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hearing test passed - </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">participant</span><span class="p">)</span>
            <span class="n">participant</span><span class="o">.</span><span class="n">set_passed_hearing_test</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">pre_evaluation_tasks</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hearing test failed - </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">participant</span><span class="p">)</span>
            <span class="n">participant</span><span class="o">.</span><span class="n">set_passed_hearing_test</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">participant</span><span class="o">.</span><span class="n">hearing_test_attempts</span> <span class="o">&lt;</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MAX_HEARING_TEST_ATTEMPTS&#39;</span><span class="p">]:</span>
                <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;You answered incorrectly. If you are unable to pass this test, it is likely that your output &#39;</span>
                      <span class="s1">&#39;device (e.g. your headphones) is not producing the full range of frequencies required for this &#39;</span>
                      <span class="s1">&#39;task. Try using better headphones.&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;HEARING_TEST_REJECTION_ENABLED&#39;</span><span class="p">]:</span>
                    <span class="c1"># They attempted, but they failed, but pass them through since rejection is not enabled</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hearing test rejection enabled. Passing failed participant to evaluation.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">pre_evaluation_tasks</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;hearing_test&#39;</span><span class="p">,</span> <span class="n">_method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/hearing_test/audio/&lt;example_num&gt;.wav&#39;</span><span class="p">)</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="hearing_test_audio"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.hearing_test_audio">[docs]</a><span class="k">def</span> <span class="nf">hearing_test_audio</span><span class="p">(</span><span class="n">example_num</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve audio for hearing test</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    example_num : str</span>
<span class="sd">        The index of the example audio (1 or 2)</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">example_num</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
        <span class="c1"># calibration file</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;hearing_test_audio/1000Hz.wav&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hearing_test_audio_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">decrypt_data</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;hearing_test_audio_index</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">example_num</span><span class="p">]))</span>
        <span class="n">num_tones</span> <span class="o">=</span> <span class="n">hearing_test_audio_index</span> <span class="o">/</span> <span class="n">configuration</span><span class="o">.</span><span class="n">HEARING_TEST_AUDIO_FILES_PER_TONES</span>
        <span class="n">file_num</span> <span class="o">=</span> <span class="n">hearing_test_audio_index</span> <span class="o">%</span> <span class="n">configuration</span><span class="o">.</span><span class="n">HEARING_TEST_AUDIO_FILES_PER_TONES</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;hearing_test </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">example_num</span><span class="p">,</span> <span class="n">num_tones</span><span class="p">,</span> <span class="n">file_num</span><span class="p">))</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;hearing_test_audio/tones</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.wav&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_tones</span><span class="p">,</span> <span class="n">file_num</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;audio/wav&#39;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Accept-Ranges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bytes&#39;</span>
    <span class="k">return</span> <span class="n">response</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/evaluation&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="evaluation"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.evaluation">[docs]</a><span class="k">def</span> <span class="nf">evaluation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renders the listening test (if GET) and saves the results (if POST)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">participant</span> <span class="o">=</span> <span class="n">get_current_participant</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># SAVE DATA</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get relevant data</span>
            <span class="n">participant</span> <span class="o">=</span> <span class="n">get_current_participant</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="n">crowd_data</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;crowd_data&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">participant_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;participant_id&#39;</span><span class="p">])</span>
            <span class="c1"># ensure that the participant_id is correct</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">participant</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">participant_id</span><span class="p">)</span>

            <span class="n">condition_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;completedConditionData&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">condition_data</span><span class="p">:</span>
                <span class="c1"># get data</span>
                <span class="n">condition_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="s1">&#39;conditionID&#39;</span><span class="p">])</span>

                <span class="c1"># decrypt audio stimuli</span>
                <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ENCRYPT_AUDIO_STIMULI_URLS&#39;</span><span class="p">]:</span>
                    <span class="n">cd</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">decrypt_audio_stimuli</span><span class="p">(</span><span class="n">cd</span><span class="p">)</span>

                <span class="c1"># create database object</span>
                <span class="n">trial</span> <span class="o">=</span> <span class="n">Trial</span><span class="p">(</span><span class="n">participant_id</span><span class="p">,</span>
                              <span class="n">condition_id</span><span class="p">,</span>
                              <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cd</span><span class="p">),</span>
                              <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">crowd_data</span><span class="p">),</span>
                              <span class="n">participant</span><span class="o">.</span><span class="n">passed_hearing_test</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Results saved for </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trial</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;POST_EVALUATION&#39;</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Data is saved!&#39;</span><span class="p">,</span> <span class="s1">&#39;trial_id&#39;</span><span class="p">:</span> <span class="n">utilities</span><span class="o">.</span><span class="n">sign_data</span><span class="p">(</span><span class="n">trial</span><span class="o">.</span><span class="n">id</span><span class="p">)})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error saving results. - </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Error saving data. Error </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">utilities</span><span class="o">.</span><span class="n">sign_data</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_configurations</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">get_test_configurations</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;condition_ids&#39;</span><span class="p">],</span> <span class="n">participant</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># for now don&#39;t consider the case that there could be more than one test per participant</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_configurations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;`test_configuration` has length greater than 1. This is not supported for now.&quot;</span>
        <span class="n">test_config</span> <span class="o">=</span> <span class="n">test_configurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TEST_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mushra&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;mushra.html&#39;</span><span class="p">,</span>
                                   <span class="n">test</span><span class="o">=</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
                                   <span class="n">condition_groups</span><span class="o">=</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;condition_groups&#39;</span><span class="p">],</span>
                                   <span class="n">conditions</span><span class="o">=</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;conditions&#39;</span><span class="p">],</span>
                                   <span class="n">participant_id</span><span class="o">=</span><span class="n">participant</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                   <span class="n">first_evaluation</span><span class="o">=</span><span class="n">participant</span><span class="o">.</span><span class="n">trials</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                   <span class="n">test_complete_redirect_url</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_evaluation_tasks&#39;</span><span class="p">,</span>
                                                                      <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                                      <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]),</span>
                                   <span class="n">submission_url</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">,</span>
                                                          <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                          <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TEST_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairwise&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;pairwise.html&#39;</span><span class="p">,</span>
                                   <span class="n">test</span><span class="o">=</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
                                   <span class="n">condition_groups</span><span class="o">=</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;condition_groups&#39;</span><span class="p">],</span>
                                   <span class="n">conditions</span><span class="o">=</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;conditions&#39;</span><span class="p">],</span>
                                   <span class="n">participant_id</span><span class="o">=</span><span class="n">participant</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                   <span class="n">first_evaluation</span><span class="o">=</span><span class="n">participant</span><span class="o">.</span><span class="n">trials</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                   <span class="n">test_complete_redirect_url</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_evaluation_tasks&#39;</span><span class="p">,</span>
                                                                      <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                                      <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]),</span>
                                   <span class="n">submission_url</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">,</span>
                                                          <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                          <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span>
        <span class="c1">###############################################################################################################</span>
        <span class="c1"># ADD NEW TEST TYPES HERE</span>
        <span class="c1">###############################################################################################################</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.html&#39;</span> <span class="o">%</span> <span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">][</span><span class="s1">&#39;test_type&#39;</span><span class="p">],</span>
                                   <span class="n">test</span><span class="o">=</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
                                   <span class="n">condition_groups</span><span class="o">=</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;condition_groups&#39;</span><span class="p">],</span>
                                   <span class="n">conditions</span><span class="o">=</span><span class="n">test_config</span><span class="p">[</span><span class="s1">&#39;conditions&#39;</span><span class="p">],</span>
                                   <span class="n">participant_id</span><span class="o">=</span><span class="n">participant</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                   <span class="n">first_evaluation</span><span class="o">=</span><span class="n">participant</span><span class="o">.</span><span class="n">trials</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                   <span class="n">test_complete_redirect_url</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_evaluation_tasks&#39;</span><span class="p">,</span>
                                                                      <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                                      <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]),</span>
                                   <span class="n">submission_url</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">,</span>
                                                          <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                          <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/post_evaluation_tasks&#39;</span><span class="p">)</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="post_evaluation_tasks"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.post_evaluation_tasks">[docs]</a><span class="k">def</span> <span class="nf">post_evaluation_tasks</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Control overall flow of post-evaluation tasks.</span>
<span class="sd">    * Present hearing response estimation if required</span>
<span class="sd">    * Present post-test survey if required</span>
<span class="sd">    * Present thank you page and submit task if required</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;POST_EVALUATION&#39;</span><span class="p">)</span>

    <span class="n">participant</span> <span class="o">=</span> <span class="n">get_current_participant</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;HEARING_RESPONSE_ESTIMATION_ENABLED&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">participant</span><span class="o">.</span><span class="n">hearing_response_estimation</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;hearing_response_estimation&#39;</span><span class="p">,</span>
                                <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;POST_TEST_SURVEY_ENABLED&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">participant</span><span class="o">.</span><span class="n">post_test_survey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_test_survey&#39;</span><span class="p">,</span>
                                <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span>

    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;END&#39;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span>
                            <span class="n">platform</span><span class="o">=</span><span class="n">participant</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span>
                            <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">]))</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/hearing_response_estimation&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="hearing_response_estimation"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.hearing_response_estimation">[docs]</a><span class="k">def</span> <span class="nf">hearing_response_estimation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform in-situ hearing response estimation (if GET) and store results (if POST)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">participant</span> <span class="o">=</span> <span class="n">get_current_participant</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">participant</span><span class="o">.</span><span class="n">hearing_response_estimation</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">post_evaluation_tasks</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hearing_response_file_path</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;static&#39;</span><span class="p">,</span>
                                             <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;audio/hearing_response_stimuli/&#39;</span><span class="p">,</span>
                                             <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                             <span class="n">_scheme</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PREFERRED_URL_SCHEME&#39;</span><span class="p">])</span>

        <span class="n">hearing_response_file_path</span> <span class="o">=</span> <span class="n">strip_query_from_url</span><span class="p">(</span><span class="n">hearing_response_file_path</span><span class="p">)</span>

        <span class="n">freq_seq</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">HEARING_RESPONSE_NFREQS</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">freq_seq</span><span class="p">)</span>

        <span class="n">hearing_response_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hearing_response_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">freq_seq</span><span class="p">:</span>
            <span class="n">hearing_response_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">configuration</span><span class="o">.</span><span class="n">HEARING_RESPONSE_NADD</span><span class="p">))</span>
            <span class="n">hearing_response_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">.wav&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hearing_response_file_path</span><span class="p">,</span> <span class="n">hearing_response_id</span><span class="p">)</span>
            <span class="n">hearing_response_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hearing_response_id</span><span class="p">)</span>
            <span class="n">hearing_response_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hearing_response_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;hearing_response_estimation.html&#39;</span><span class="p">,</span>
                               <span class="n">hearing_response_ids</span><span class="o">=</span><span class="n">hearing_response_ids</span><span class="p">,</span>
                               <span class="n">hearing_response_files</span><span class="o">=</span><span class="n">hearing_response_files</span><span class="p">,</span>
                               <span class="n">n_options</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;HEARING_RESPONSE_NOPTIONS&#39;</span><span class="p">])</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/post_test_survey&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="post_test_survey"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.post_test_survey">[docs]</a><span class="k">def</span> <span class="nf">post_test_survey</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display post-test survey (if GET) and store results (if POST)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">participant</span> <span class="o">=</span> <span class="n">get_current_participant</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">participant</span><span class="o">.</span><span class="n">post_test_survey</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">post_evaluation_tasks</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;post_test_survey.html&#39;</span><span class="p">)</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/end/&lt;platform&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="end"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.end">[docs]</a><span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="n">platform</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a thank you page with a button on it that directs submits their task or simply closes the window (depending</span>
<span class="sd">    on the platform)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    platform : str</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># assert state so that workers don&#39;t try to just jump to the end</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;END&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;mturk&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;mturk/end.html&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;end.html&#39;</span><span class="p">)</span></div>


<span class="c1"># ADMINISTRATIVE AND TESTING VIEWS</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/mturk_debug&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="mturk_debug"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.mturk_debug">[docs]</a><span class="k">def</span> <span class="nf">mturk_debug</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This just a view for previewing what the page would look like on Mechanical Turk</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">preview</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preview&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">preview</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;mturk_debug.html&#39;</span><span class="p">,</span>
                               <span class="n">url</span><span class="o">=</span><span class="s1">&#39;/mturk?assignmentId=ASSIGNMENT_ID_NOT_AVAILABLE&amp;workerId=debugNQFUCL&#39;</span><span class="p">,</span>
                               <span class="n">frame_height</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MTURK_FRAME_HEIGHT&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;mturk_debug.html&#39;</span><span class="p">,</span>
                               <span class="n">url</span><span class="o">=</span><span class="s1">&#39;/mturk?assignmentId=123RVWYBAZW00EXAMPLE456RVWYBAZW00EXAMPLE&amp;&#39;</span>
                                   <span class="s1">&#39;hitId=123RVWYBAZW00EXAMPLE&amp;&#39;</span>
                                   <span class="s1">&#39;turkSubmitTo=https://workersandbox.mturk.com&amp;&#39;</span>
                                   <span class="s1">&#39;workerId=debugNQFUCL&#39;</span><span class="p">,</span>
                               <span class="n">frame_height</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MTURK_FRAME_HEIGHT&#39;</span><span class="p">])</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/admin/stats&#39;</span><span class="p">)</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="admin_stats"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.admin_stats">[docs]</a><span class="k">def</span> <span class="nf">admin_stats</span><span class="p">():</span>
    <span class="n">trials</span> <span class="o">=</span> <span class="n">Trial</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="n">Condition</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">passed_hearing_condition_count</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">cond</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">])</span>
    <span class="n">failed_hearing_condition_count</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">cond</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="n">trials</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">participant_passed_hearing_test</span><span class="p">:</span>
            <span class="n">passed_hearing_condition_count</span><span class="p">[</span><span class="n">trial</span><span class="o">.</span><span class="n">condition_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failed_hearing_condition_count</span><span class="p">[</span><span class="n">trial</span><span class="o">.</span><span class="n">condition_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="s1">&#39;Completed Trials (passed hearing test)&#39;</span><span class="p">,</span> <span class="s1">&#39;Completed Trials (failed hearing test)&#39;</span><span class="p">]</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">passed_hearing_condition_count</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;Condition&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
             <span class="s1">&#39;Completed Trials (passed hearing test)&#39;</span><span class="p">:</span> <span class="n">passed_hearing_condition_count</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
             <span class="s1">&#39;Completed Trials (failed hearing test)&#39;</span><span class="p">:</span> <span class="n">failed_hearing_condition_count</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Trial Statistics&#39;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;table.html&#39;</span><span class="p">,</span>
                           <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">,</span>
                           <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
                           <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span></div>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/bonus&#39;</span><span class="p">)</span>
<span class="nd">@nocache</span>
<div class="viewcode-block" id="bonus"><a class="viewcode-back" href="../../source/caqe.views.html#caqe.views.bonus">[docs]</a><span class="k">def</span> <span class="nf">bonus</span><span class="p">():</span>
    <span class="n">worker_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workerId&#39;</span><span class="p">,</span> <span class="s1">&#39;WORKER_ID_NOT_AVAILABLE&#39;</span><span class="p">)</span>
    <span class="n">hit_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hitId&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;assignmentId&#39;</span><span class="p">]</span>
    <span class="n">turk_submit_to</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;turkSubmitTo&#39;</span><span class="p">,</span> <span class="s1">&#39;TURK_SUBMIT_TO_NOT_AVAILABLE&#39;</span><span class="p">),</span>
                                      <span class="s1">&#39;/mturk/externalSubmit&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;bonus.html&#39;</span><span class="p">,</span>
                           <span class="n">turk_submit_to</span><span class="o">=</span><span class="n">turk_submit_to</span><span class="p">,</span>
                           <span class="n">worker_id</span><span class="o">=</span><span class="n">worker_id</span><span class="p">,</span>
                           <span class="n">hit_id</span><span class="o">=</span><span class="n">hit_id</span><span class="p">,</span>
                           <span class="n">assignment_id</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span>
                           <span class="n">preview</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">][</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="s1">&#39;ASSIGNMENT_ID_NOT_AVAILABLE&#39;</span><span class="p">])</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Copyright (c) 2016 Mark Cartwright.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.1a1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>